generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model departments {
  id       String     @id @db.VarChar(50)
  name     String     @db.VarChar(100)
  faculty  faculty[]
  students students[]
  subjects subjects[]
}

model faculty {
  id            String      @id @db.VarChar(50)
  name          String      @db.VarChar(100)
  email         String      @unique(map: "email") @db.VarChar(150)
  department_id String      @db.VarChar(50)
  faculty_code  String?     @db.VarChar(50)
  user_id       String?     @db.VarChar(50)
  departments   departments @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "faculty_ibfk_1")
  user          users?      @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "faculty_user_fk")

  @@index([department_id], map: "department_id")
  @@index([user_id], map: "faculty_user_id")
}

model feedback_forms {
  id                 String                @id @db.VarChar(50)
  subject_name       String                @db.VarChar(150)
  subject_code       String?               @db.VarChar(50)
  faculty_name       String                @db.VarChar(100)
  faculty_email      String                @db.VarChar(150)
  division           String                @db.VarChar(10)
  batch              String?               @db.VarChar(10)
  semester           Int                   @db.TinyInt
  course             String                @default("IT") @db.VarChar(50)
  academic_year      String                @default("2025-26") @db.VarChar(10)
  status             feedback_forms_status @default(active)
  created_at         DateTime?             @default(now()) @db.Timestamp(0)
  feedback_responses feedback_responses[]
  form_questions     form_questions[]

  // Indexes for efficient student dashboard queries
  @@index([semester, course, division, status], map: "idx_student_forms")
  @@index([faculty_email], map: "idx_faculty_email")
}

// Snapshot of questions for each form (copied from feedback_parameters at form creation)
model form_questions {
  id                BigInt         @id @default(autoincrement())
  form_id           String         @db.VarChar(50)
  original_param_id String         @db.VarChar(50)  // Original parameter ID for response tracking
  question_text     String         @db.VarChar(255)
  position          Int
  question_type     String         @default("scale_1_10") @db.VarChar(30)
  feedback_forms    feedback_forms @relation(fields: [form_id], references: [id], onDelete: Cascade)

  @@index([form_id], map: "form_id")
}

model feedback_parameters {
  id            String @id @db.VarChar(50)
  text          String @db.VarChar(255)
  position      Int
  form_type     String @default("theory") @db.VarChar(20)
  question_type String @default("scale_1_10") @db.VarChar(30)
}

model feedback_response_items {
  id                  BigInt              @id @default(autoincrement())
  response_id         String              @db.VarChar(50)
  parameter_id        String              @db.VarChar(50)  // Just a reference string, no FK constraint
  rating              Int                 @db.TinyInt
  question_text       String?             @db.VarChar(255)  // Snapshot of question at submission time
  question_type       String?             @db.VarChar(30)   // Snapshot of question type at submission time
  feedback_responses  feedback_responses  @relation(fields: [response_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "feedback_response_items_ibfk_1")

  @@index([parameter_id], map: "parameter_id")
  @@index([response_id], map: "response_id")
}

model feedback_responses {
  id                      String                    @id @db.VarChar(50)
  form_id                 String                    @db.VarChar(50)
  student_id              String                    @db.VarChar(50)
  comment                 String?                   @db.Text
  submitted_at            DateTime?                 @default(now()) @db.Timestamp(0)
  feedback_response_items feedback_response_items[]
  feedback_forms          feedback_forms            @relation(fields: [form_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "feedback_responses_ibfk_1")
  students                students                  @relation(fields: [student_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "feedback_responses_ibfk_2")

  @@unique([form_id, student_id], map: "unique_form_student")
  @@index([form_id], map: "form_id")
  @@index([student_id], map: "student_id")
}

model students {
  id                 String               @id @db.VarChar(50)
  name               String               @db.VarChar(100)
  email              String               @unique(map: "email") @db.VarChar(150)
  department_id      String               @db.VarChar(50)
  semester           Int                  @db.TinyInt
  course             String               @default("IT") @db.VarChar(50)
  division           String               @db.VarChar(10)
  batch              String?              @db.VarChar(10)
  user_id            String?              @db.VarChar(50)
  feedback_responses feedback_responses[]
  departments        departments          @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "students_ibfk_1")
  user               users?               @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "students_user_fk")

  @@index([department_id], map: "department_id")
  @@index([user_id], map: "students_user_id")
}

model subjects {
  id            String      @id @db.VarChar(50)
  name          String      @db.VarChar(150)
  code          String      @db.VarChar(50)
  department_id String      @db.VarChar(50)
  departments   departments @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "subjects_ibfk_1")

  @@index([department_id], map: "department_id")
}

model users {
  id         String     @id @db.VarChar(50)
  name       String     @db.VarChar(100)
  email      String     @unique(map: "email") @db.VarChar(150)
  role       users_role
  created_at DateTime?  @default(now()) @db.Timestamp(0)
  students   students[]
  faculty    faculty[]
}

enum users_role {
  student
  faculty
  admin
}

enum feedback_forms_status {
  active
  closed
}

model admin_users {
  id         String    @id @db.VarChar(50)
  email      String    @unique @db.VarChar(255)
  name       String?   @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamp(0)
}

// Timetable - stores faculty-subject-class mappings for generating forms
model timetable {
  id            BigInt    @id @default(autoincrement())
  subject_name  String    @db.VarChar(150)
  faculty_email String    @db.VarChar(150)
  semester      Int       @db.TinyInt
  course        String    @db.VarChar(50)
  division      String    @db.VarChar(10)
  batch         String?   @db.VarChar(10)  // NULL for theory subjects
  academic_year String    @db.VarChar(10)
  created_at    DateTime? @default(now()) @db.Timestamp(0)

  @@index([semester, course, division], map: "idx_timetable_class")
  @@index([faculty_email], map: "idx_timetable_faculty")
  @@index([academic_year], map: "idx_timetable_year")
}
